<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Online Test | Elumalai's Chemistry Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="test_ui.css">
</head>

<body>

<!-- ================= INSTRUCTIONS ================= -->
<section id="instructionPage" class="instruction-page">
  <div class="instruction-box">
    <h2>üìù Test Instructions</h2>

    <ul>
      <li>Total Questions: <span id="instTotalQ">--</span></li>
      <li>Total Time: <span id="instTime">--</span> Minutes</li>
      <li>No negative marking</li>
      <li>Do not refresh or exit fullscreen</li>
      <li>Auto submit when time ends</li>
    </ul>

    <label class="agree">
      <input type="checkbox" id="agreeChk">
      I agree to the instructions
    </label>

    <button id="startBtn" disabled>Start Test</button>
  </div>
</section>

<!-- ================= TEST UI ================= -->
<section id="testUI" class="test-ui hidden">

  <header class="test-header">
    <span>Elumalai's Chemistry Academy</span>
    <span class="timer" id="timer">00:00</span>
  </header>

  <div class="test-body">

    <!-- Question Area -->
    <div class="question-panel">
      <h3 id="questionText"></h3>
      <img id="questionImage" class="question-img hidden">
      <div class="options" id="options"></div>

      <div class="nav-btns">
        <button onclick="prevQ()">Previous</button>
        <button onclick="saveAndNext()">Save & Next</button>
        <button onclick="markForReview()">Mark for Review</button>
        <button onclick="nextQ()">Next</button>
      </div>
    </div>

    <!-- Palette -->
    <aside class="palette">
      <h4>Questions</h4>
      <div id="qPalette"></div>
      <button class="submit-btn" onclick="submitTest()">Submit Test</button>
    </aside>

  </div>
</section>

<script>
/* ================= AUTH ================= */
const token = localStorage.getItem("token");
if (!token) location.href = "login.html";

/* ================= PARAM ================= */
const testId = new URLSearchParams(window.location.search).get("test_id");
if (!testId) alert("Invalid Test");

/* ================= STATE ================= */
let questions = [];
let current = 0;
let answers = {};
let qStatus = {}; // not_visited | seen | answered | review
let timeLeft = 0;
let timerInterval = null;

let batchName = "";
let testName = "";

/* ================= ELEMENTS ================= */
const instructionPage = document.getElementById("instructionPage");
const testUI = document.getElementById("testUI");
const startBtn = document.getElementById("startBtn");
const agreeChk = document.getElementById("agreeChk");
const questionText = document.getElementById("questionText");
const questionImage = document.getElementById("questionImage");
const optionsDiv = document.getElementById("options");
const palette = document.getElementById("qPalette");
const timer = document.getElementById("timer");

/* ================= LOAD TEST ================= */
async function loadTest() {
  const res = await fetch(`/api/questions/test/${testId}`, {
    headers: { Authorization: "Bearer " + token }
  });

  const data = await res.json();
  if (!data.success) {
    alert("Failed to load test");
    return;
  }

  questions = data.questions || [];
  batchName = data.batch_name;
  testName = data.test_name;

  document.getElementById("instTotalQ").innerText = questions.length;
  document.getElementById("instTime").innerText = data.test_time;

  timeLeft = data.test_time * 60;
  buildPalette();
}
loadTest();

/* ================= START ================= */
agreeChk.addEventListener("change", () => {
  startBtn.disabled = !agreeChk.checked;
});

startBtn.addEventListener("click", () => {
  document.documentElement.requestFullscreen?.();
  instructionPage.style.display = "none";
  testUI.classList.remove("hidden");

  loadQuestion(0);
  startTimer();
});

/* ================= IMAGE PATH ================= */
function imagePath(file) {
  return `/uploads/questions/${batchName}/${testName}/${file}`;
}

/* ================= LOAD QUESTION ================= */
function loadQuestion(i) {
  current = i;
  const q = questions[i];
  if (!q) return;

  if (!qStatus[q.question_id]) {
    qStatus[q.question_id] = "seen";
  }

  questionText.innerText = `Q${i + 1}. ${q.question_text || ""}`;

  if (q.question_image) {
    questionImage.src = imagePath(q.question_image);
    questionImage.classList.remove("hidden");
  } else {
    questionImage.classList.add("hidden");
  }

  optionsDiv.innerHTML = "";

  ["a","b","c","d"].forEach(k => {
    const text = q[`option_${k}_text`];
    const img = q[`option_${k}_image`];
    if (!text && !img) return;

    const label = document.createElement("label");
    label.className = "option";
    label.innerHTML = `
      <input type="radio" name="q_${q.question_id}" value="${k.toUpperCase()}"
        ${answers[q.question_id] === k.toUpperCase() ? "checked" : ""}>
      <span>${text || ""}</span>
      ${img ? `<img src="${imagePath(img)}" class="option-img">` : ""}
    `;

    label.querySelector("input").onchange = () => {
      answers[q.question_id] = k.toUpperCase();
    };

    optionsDiv.appendChild(label);
  });

  highlightPalette();
}

/* ================= NAVIGATION ================= */
function nextQ() {
  if (current < questions.length - 1) loadQuestion(current + 1);
}
function prevQ() {
  if (current > 0) loadQuestion(current - 1);
}

/* ================= ACTION BUTTONS ================= */
function saveAndNext() {
  const qId = questions[current].question_id;
  qStatus[qId] = answers[qId] ? "answered" : "seen";
  highlightPalette();
  nextQ();
}

function markForReview() {
  const qId = questions[current].question_id;
  qStatus[qId] = "review";
  highlightPalette();
  nextQ();
}

/* ================= PALETTE ================= */
function buildPalette() {
  palette.innerHTML = "";
  questions.forEach((_, i) => {
    const btn = document.createElement("button");
    btn.innerText = i + 1;
    btn.onclick = () => loadQuestion(i);
    palette.appendChild(btn);
  });
}

function highlightPalette() {
  [...palette.children].forEach((btn, i) => {
    const qId = questions[i].question_id;
    btn.className = "";

    if (i === current) {
      btn.classList.add("active");
      return;
    }

    if (qStatus[qId] === "answered") btn.classList.add("answered");
    else if (qStatus[qId] === "review") btn.classList.add("review");
    else if (qStatus[qId] === "seen") btn.classList.add("seen");
  });
}

/* ================= TIMER ================= */
function startTimer() {
  if (timerInterval) return;

  timerInterval = setInterval(() => {
    const min = Math.floor(timeLeft / 60);
    const sec = timeLeft % 60;
    timer.innerText = `${min}:${sec < 10 ? "0" : ""}${sec}`;

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      submitTest();
    }
    timeLeft--;
  }, 1000);
}

/* ================= SUBMIT ================= */
async function submitTest() {
  clearInterval(timerInterval);

  const res = await fetch("/api/tests/submit", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ test_id: testId, answers })
  });

  const data = await res.json();
  if (!data.success) {
    alert("Submission failed");
    return;
  }

  location.href = `results.html?attempt_id=${data.attempt_id}`;
}

/* ================= FULLSCREEN BLOCK ================= */
document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement) {
    alert("Do not exit fullscreen during the test!");
  }
});
</script>

</body>
</html>
