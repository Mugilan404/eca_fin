<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test Result | Elumalai's Chemistry Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    header {
      background: #1e293b;
      color: #fff;
      padding: 15px 25px;
      font-size: 18px;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    .summary {
      display: grid;
      grid-template-columns: 300px auto;
      gap: 30px;
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .chart-box {
      text-align: center;
    }

    .question-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .question-img {
      max-width: 100%;
      margin: 10px 0;
      border-radius: 6px;
    }

    .option {
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option img {
      max-width: 120px;
      border-radius: 4px;
    }

    .correct {
      background: #dcfce7;
      border-color: #22c55e;
    }

    .wrong {
      background: #fee2e2;
      border-color: #ef4444;
    }

    .reference {
      margin-top: 10px;
      font-size: 14px;
    }

    .reference a {
      color: #2563eb;
      text-decoration: none;
    }

    footer {
      text-align: center;
      padding: 15px;
      color: #777;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header>
  ðŸ§ª Elumalai's Chemistry Academy â€” Test Result
</header>

<div class="container">

  <!-- ===== SUMMARY ===== -->
  <div class="summary">
    <div class="chart-box">
      <h3>Score</h3>
      <canvas id="resultChart" width="250" height="140"></canvas>
      <p><strong id="scoreText"></strong></p>
    </div>

    <div>
      <h2 id="testName">Loading...</h2>
      <p>Total Questions: <span id="totalQ"></span></p>
      <p>Correct Answers: <span id="correctQ"></span></p>
      <p>Attempted On: <span id="attemptDate"></span></p>
    </div>
  </div>
<div style="margin: 20px 0;">
  <a href="user_dashboard.html"
     style="
       display: inline-block;
       padding: 10px 18px;
       background: #1e293b;
       color: #fff;
       border-radius: 6px;
       text-decoration: none;
       font-weight: 600;
     ">
    â¬… Go to Dashboard
  </a>
</div>


  <!-- ===== QUESTIONS REVIEW ===== -->
  <div id="questionsContainer"></div>

</div>



<footer>
  Â© 2026 Elumalai's Chemistry Academy
</footer>

<script>
/* ================= AUTH ================= */
const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

/* ================= PARAM ================= */
const params = new URLSearchParams(window.location.search);
const attemptId = params.get("attempt_id");
if (!attemptId) alert("Invalid attempt");

/* ================= CONTEXT ================= */
let batchName = "";
let testName = "";

/* ================= IMAGE PATH ================= */
function imagePath(filename) {
  if (!filename) return "";
  return `/uploads/questions/${batchName}/${testName}/${filename}`;
}

/* ================= LOAD RESULT ================= */
async function loadResult() {
  const res = await fetch(`/api/tests/result/${attemptId}`, {
    headers: { Authorization: "Bearer " + token }
  });

  const data = await res.json();
  if (!data.success) {
    alert(data.message);
    return;
  }

  const r = data.result;

  /* ðŸ”¥ normalize folder names */
  batchName = r.batch_name.replace(/\s+/g, "_");
  testName  = r.test_name.replace(/\s+/g, "_");

  document.getElementById("testName").innerText = r.test_name;
  document.getElementById("totalQ").innerText = r.total_questions;
  document.getElementById("correctQ").innerText = r.correct_answers;
  document.getElementById("attemptDate").innerText =
    new Date(r.completed_at).toLocaleString();

  document.getElementById("scoreText").innerText =
    `${r.score} / ${r.total_questions}`;

  buildChart(r.score, r.total_questions - r.score);

  const qc = document.getElementById("questionsContainer");
  qc.innerHTML = "";

  r.questions.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question-card";

    div.innerHTML = `
      <h4>Q${i + 1}. ${q.question_text || ""}</h4>

      ${
        q.question_image
          ? `<img src="${imagePath(q.question_image)}" class="question-img">`
          : ""
      }

      ${renderOption("A", q.option_a_text, q.option_a_image, q)}
      ${renderOption("B", q.option_b_text, q.option_b_image, q)}
      ${renderOption("C", q.option_c_text, q.option_c_image, q)}
      ${renderOption("D", q.option_d_text, q.option_d_image, q)}

      ${
        q.reference_video_url
          ? `<div class="reference">ðŸ“˜ Reference:
              <a href="${q.reference_video_url}" target="_blank">
                ${q.reference_text}
              </a>
            </div>`
          : ""
      }
    `;

    qc.appendChild(div);
  });
}

/* ================= OPTION RENDER ================= */
function renderOption(letter, text, image, q) {
  if (!text && !image) return "";

  let cls = "option";

  const isSelected = q.selected_option === letter;
  const isCorrect = q.correct_answer === letter;

  if (isSelected && isCorrect) cls += " correct";
  else if (isSelected && !isCorrect) cls += " wrong";
  else if (!isSelected && isCorrect) cls += " correct";

  return `
    <div class="${cls}">
      <strong>${letter}.</strong>
      <span>${text || ""}</span>
      ${image ? `<img src="${imagePath(image)}">` : ""}
    </div>
  `;
}

/* ================= CHART ================= */
function buildChart(correct, wrong) {
  new Chart(document.getElementById("resultChart"), {
    type: "doughnut",
    data: {
      labels: ["Correct", "Wrong"],
      datasets: [{
        data: [correct, wrong],
        backgroundColor: ["#22c55e", "#ef4444"]
      }]
    },
    options: {
      rotation: -90,
      circumference: 180,
      cutout: "70%",
      plugins: { legend: { display: false } }
    }
  });
}

loadResult();
</script>

</body>
</html>
